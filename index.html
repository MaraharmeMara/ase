<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Ase</title>

    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
    <script src="./assets/gesture-detector.js"></script>
    <script src="./assets/gesture-handler.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <style>
      .scn {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 100000;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body style="margin: 0px; overflow: hidden">
    <div class="container fixed-top">
      <div class="col-6">
        <button class="btn btn-info hint-btn btn-lg">
          ?
          <span class="spinner-border spinner-border-sm loadingCheck"></span>
        </button>

        <img
          class="row hint-img d-none"
          src="./viinitorni_ohje(suurempi).gif"
          alt=""
        />
      </div>
    </div>
    <div id="reader"></div>
    <div class="scn">
      <a-scene
        id="scene"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector
        embedded
      >
        <a-entity
          raycaster="objects: .clickable"
          emitevents="true"
          class="clickable"
          rotation="0 90 0"
          position="0 1 -6"
          scale="0.1 0.1 0.1"
          gltf-model="./1.glb"
          gesture-handler
          visible="true"
        ></a-entity>

        <a-entity
          camera="active: true"
          wasd-controls
          position="0 1.6 0"
          data-aframe-default-camera
        ></a-entity>

        <!-- <a-entity camera></a-entity> -->
        <!-- Ambient Light -->
        <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
        <!-- Directional Light -->
        <a-light
          type="directional"
          color="#ffffff"
          intensity="0.8"
          position="2 4 -3"
        ></a-light>
      </a-scene>
    </div>

    <script>
      const hintBtn = document.querySelector(".hint-btn");
      hintBtn.addEventListener("click", () => {
        const hintImg = document.querySelector(".hint-img");
        hintImg.classList.toggle("d-none");
      });

      const loads = document.querySelector(".clickable");
      loads.addEventListener("model-loaded", () => {
        //
        const loadingCheck = document.querySelector(".loadingCheck");
        loadingCheck.classList.toggle("d-none");
      });

      let currentModel = "";
      function onScanSuccess(decodedText, decodedResult) {
        if (decodedText === currentModel) {
          return;
        }
        currentModel = decodedText;
        const qr = new URL(currentModel).searchParams.get("qr");
        loads.setAttribute("gltf-model", `/${qr}.glb`);
      }

      function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // for example:
        // console.warn(`Code scan error = ${error}`);
      }

      try {
        const html5QrCode = new Html5Qrcode("reader", {
          formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE],
        });
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10 },
          onScanSuccess,
          onScanFailure
        );
      } catch (e) {
        alert(e);
      }

      //
      //     /* model on a place for some time */
      //   window.addEventListener('load', function() {
      //   var modelEntity = document.querySelector('.clickable');

      //   // Delay in milliseconds before the model disappears (e.g., 5000ms = 5 seconds)
      //   var delayBeforeDisappear = 5000;

      //  function showModel() {
      //    modelEntity.setAttribute('visible', 'true');
      //   setTimeout(hideModel, delayBeforeDisappear);
      //   }

      //  function hideModel() {
      //   modelEntity.setAttribute('visible', 'false');
      //   }

      //   // Listen for the marker-found event to show the model when the marker is detected
      //   document.querySelector('a-marker').addEventListener('markerFound', showModel);
      //   });
      // window.addEventListener("load", function () {
      //   var modelEntity = document.querySelector(".clickable");
      //   var marker = document.querySelector("#markerA");

      //   var deviceOrientation = null;
      //   var modelQuaternion = new THREE.Quaternion();

      //   function updateModelPosition() {
      //     if (deviceOrientation) {
      //       var quaternion = new THREE.Quaternion(
      //         deviceOrientation.x,
      //         deviceOrientation.y,
      //         deviceOrientation.z,
      //         deviceOrientation.w
      //       );
      //       modelQuaternion.multiplyQuaternions(quaternion, modelQuaternion);
      //       modelEntity.setAttribute(
      //         "rotation",
      //         modelQuaternion.toEuler().toVector3()
      //       );
      //     }
      //     requestAnimationFrame(updateModelPosition);
      //   }

      //   function onDeviceOrientationChange(event) {
      //     deviceOrientation = event.detail;
      //   }

      //   // Listen for the marker-found event to show the model when the marker is detected
      //   document
      //     .querySelector("a-marker")
      //     .addEventListener("markerFound", function () {
      //       modelEntity.setAttribute("visible", "true");
      //       window.addEventListener(
      //         "deviceorientation",
      //         onDeviceOrientationChange
      //       );
      //       updateModelPosition();
      //     });

      //   // Listen for the marker-lost event to hide the model when the marker is not detected
      //   document
      //     .querySelector("a-marker")
      //     .addEventListener("markerLost", function () {
      //       modelEntity.setAttribute("visible", "false");
      //       window.removeEventListener(
      //         "deviceorientation",
      //         onDeviceOrientationChange
      //       );
      //     });
      // });
    </script>
  </body>
</html>
