<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR</title>

    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
    <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>    
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.5/aframe/build/aframe-ar.js"></script>
    <script src="./assets/gesture-detector.js"></script>
    <script src="./assets/gesture-handler.js"></script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
      crossorigin="anonymous"
    />
    <style>
      .scn {
        position: absolute;
        top: 0;
        left: 0;
        z-index: 100000;
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body style="margin: 0px; overflow: hidden">
    <a-scene embedded arjs="sourceType: webcam; detectionMode: mono_and_matrix;">
      <!-- Ground detection entity -->
      <a-plane position="0 0 0" rotation="90 0 0" width="10" height="10" color="#00ff00"></a-plane>

    <div class="container fixed-top">
      <img class="row hint-img d-none" src="./assets/help.gif" alt="" />
      <div class="col-6">
        <button class="btn btn-info hint-btn btn-lg">
          
          <span class="spinner-border spinner-border-sm loadingCheck"></span>
        </button>
      </div>
    </div>
    <div id="reader"></div>
    <div class="scn">
      <a-scene
        id="scene"
        renderer="logarithmicDepthBuffer: true;"
        vr-mode-ui="enabled: false"
        gesture-detector
        embedded
      >
        <a-entity
          raycaster="objects: .clickable"
          emitevents="true"
          class="clickable"
          rotation="0 90 0"
          position="0 1 -6"
          scale="0.1 0.1 0.1"
          gltf-model="./models/1.glb"
          gesture-handler
          visible="true"
        ></a-entity>

        <a-entity
          camera="active: true"
          wasd-controls
          position="0 1.6 0"
          data-aframe-default-camera
        ></a-entity>

        <!-- <a-entity camera></a-entity> -->
        <!-- Ambient Light -->
        <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
        <!-- Directional Light -->
        <a-light
          type="directional"
          color="#ffffff"
          intensity="0.8"
          position="2 4 -3"
        ></a-light>
        <sky-light type="ambient" color="#ffffff" intensity="1"> </sky-light>
      </a-scene>

      <!-- 2 scene trying1 -->
      <a-scene id="combinedScene" vr-mode-ui="enabled: false">
        <!-- Common 3D content goes here -->
        <a-entity
          id="common3DObject"
          gltf-model="./models/1.glb"
          position="0 1 -6"
          scale="0.1 0.1 0.1"
          visible="true"
        ></a-entity>
      </a-scene>
      <button id="toggleBackgroundButton">Background</button>

    </div>

    <script>
      const hintBtn = document.querySelector(".hint-btn");
      hintBtn.addEventListener("click", () => {
        const hintImg = document.querySelector(".hint-img");
        hintImg.classList.toggle("d-none");
      });

      const loads = document.querySelector(".clickable");
      loads.addEventListener("model-loaded", () => {
        //
        const loadingCheck = document.querySelector(".loadingCheck");
        loadingCheck.classList.toggle("d-none");
      });

      const urlParams = new URLSearchParams(window.location.search);
      const qrnumber = urlParams.get("qr");
      loads.setAttribute("gltf-model", `./models/${qrnumber}.glb`);

      let currentModel = "";
      function onScanSuccess(decodedText, decodedResult) {
        if (decodedText === currentModel) {
          return;
        }
        currentModel = decodedText;
        const qr = new URL(currentModel).searchParams.get("qr");
        if (qr === "") {
          return;
        }
        console.log(currentModel);
        loads.setAttribute("gltf-model", `./models/${qr}.glb`);
      }

      function onScanFailure(error) {
        // handle scan failure, usually better to ignore and keep scanning.
        // for example:
        // console.warn(`Code scan error = ${error}`);
      }

      try {
        const html5QrCode = new Html5Qrcode("reader", {
          formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE],
        });
        html5QrCode.start(
          { facingMode: "environment" },
          { fps: 10 },
          onScanSuccess,
          onScanFailure
        );
      } catch (e) {
        alert(e);
      }
      const toggleBackgroundButton = document.getElementById('toggleBackgroundButton');
const combinedScene = document.getElementById('combinedScene');
const common3DObject = document.getElementById('common3DObject');

toggleBackgroundButton.addEventListener('click', function () {
  if (combinedScene.getAttribute('environment') === 'preset: forest') {
    combinedScene.setAttribute('environment', 'preset: default');
  } else {
    combinedScene.setAttribute('environment', 'preset: forest');
  }
});

// Function to toggle the visibility of the 3D object
function toggle3DObject() {
  if (common3DObject.getAttribute('visible')) {
    common3DObject.setAttribute('visible', false);
  } else {
    common3DObject.setAttribute('visible', true);
  }
}

// Call the toggle3DObject function to initially hide the 3D object
toggle3DObject();

    </script>
  </body>
</html>
